// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id               Int              @id @default(autoincrement())
  name             String
  description      String?
  imageUrl         String?
  order            Int              @default(0)
  active           Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  variants         ServiceVariant[]
  serviceMaterials ServiceMaterial[]
  appointments     Appointment[]
}

model ServiceVariant {
  id            Int           @id @default(autoincrement())
  serviceId     Int
  name          String
  description   String?
  durationMin   Int // duration in minutes
  price         Float
  order         Int           @default(0)
  active        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  service       Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  appointments  Appointment[]
}

model Material {
  id               Int              @id @default(autoincrement())
  name             String
  description      String?
  stockQuantity    Int              @default(0)
  unit             String           @default("un") // un, kg, m, etc
  minStock         Int              @default(0) // alert threshold
  active           Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  serviceMaterials ServiceMaterial[]
}

model ServiceMaterial {
  id         Int      @id @default(autoincrement())
  serviceId  Int
  materialId Int
  quantity   Float    @default(1) // quantity used per service
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([serviceId, materialId])
}

model Client {
  id                 Int           @id @default(autoincrement())
  name               String
  phone              String        @unique
  email              String?
  cpf                String?
  gender             String?       // "M", "F", "Other"
  birthDate          DateTime?
  profilePhoto       String?       // URL/path to profile photo
  address            String?
  notes              String?
  lgpdConsent        Boolean       @default(false)
  lgpdConsentDate    DateTime?
  marketingConsent   Boolean       @default(false)
  firstVisit         DateTime?
  lastVisit          DateTime?
  totalVisits        Int           @default(0)
  totalSpent         Float         @default(0)
  averageRating      Float?
  tags               String?       // JSON array stored as string
  active             Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  appointments       Appointment[]
  photos             ClientPhoto[]
}

model ClientPhoto {
  id            Int          @id @default(autoincrement())
  clientId      Int
  appointmentId Int?
  photoUrl      String
  description   String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([appointmentId])
}

model Policy {
  id               Int      @id @default(autoincrement())
  type             String   // "cancellation", "rescheduling", "payment", "lgpd"
  title            String
  content          String   // markdown or HTML
  hoursBeforeLimit Int?     // for cancellation/rescheduling policies
  active           Boolean  @default(true)
  order            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model AvailabilityRule {
  id          Int      @id @default(autoincrement())
  dayOfWeek   Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Block {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  recurring   Boolean   @default(false)
  recurrenceRule String? // RRULE format for recurring blocks
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Appointment {
  id                Int             @id @default(autoincrement())
  clientId          Int
  serviceId         Int
  variantId         Int?
  scheduledStart    DateTime
  scheduledEnd      DateTime
  status            String          @default("pending") // pending, confirmed, in_progress, completed, cancelled, no_show
  price             Float?
  paymentStatus     String          @default("pending") // pending, paid, refunded
  paymentMethod     String?         // pix, cash, card, transfer
  pixPayload        String?
  notes             String?
  internalNotes     String?
  photos            String?         // JSON array of URLs stored as string
  rating            Int?            // 1-5
  feedback          String?
  cancellationReason String?
  cancelledAt       DateTime?
  confirmedAt       DateTime?
  completedAt       DateTime?
  noShowAt          DateTime?
  reminderSent      Boolean         @default(false)
  reminderSentAt    DateTime?
  managementToken   String          @unique // for client self-service links
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  client            Client          @relation(fields: [clientId], references: [id])
  service           Service         @relation(fields: [serviceId], references: [id])
  variant           ServiceVariant? @relation(fields: [variantId], references: [id])
  clientPhotos      ClientPhoto[]

  @@index([scheduledStart])
  @@index([status])
  @@index([clientId])
}

model MessageTemplate {
  id        Int      @id @default(autoincrement())
  type      String   // "confirmation", "reminder", "cancellation", "rescheduling", "thank_you", "no_show_followup"
  name      String
  content   String   // WhatsApp message template with variables: {{clientName}}, {{serviceName}}, {{date}}, {{time}}, {{price}}, {{cancelLink}}, {{rescheduleLink}}
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Settings {
  id                   Int      @id @default(autoincrement())
  key                  String   @unique
  value                String   // JSON stored as string
  description          String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}